@model HRMS.Models.Attendance
@{
    ViewData["Title"] = "Attendance";
    var role = ViewBag.UserRole as string;

    bool hasCheckedIn = Model?.InTime != null;
    bool hasCheckedOut = Model?.OutTime != null;

    if (role == "HR" || role == "VP" || role == "GM" || role == "Director")
    {
        Layout = "~/Views/Shared/_HrLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_EmployeeLayout.cshtml";
    }

    string FormatTime(object time)
    {
        if (time == null) return "—";
        if (time is TimeSpan ts) return DateTime.Today.Add(ts).ToString("dd MMM yyyy, hh:mm tt");
        if (time is DateTime dt) return dt.ToString("dd MMM yyyy, hh:mm tt");
        return "—";
    }
}

<div class="att-page">
    <div class="att-container shadow-lg">

        <!-- HEADER -->
        <div class="att-header">
            <div class="att-header-icon">
                <i class="fa-solid fa-clock"></i>
            </div>
            <div>
                <h2 class="att-title">Attendance Panel</h2>
                <p class="att-subtitle">Track your work hours & check-in / check-out status</p>
            </div>
        </div>

        <!-- GEO ERROR -->
        <div id="geoError" class="alert alert-danger text-center d-none mt-3"></div>

        <!-- SUCCESS MESSAGE -->
        @if (hasCheckedOut && TempData["CheckoutSuccess"] != null)
        {
            <div class="alert alert-success text-center fw-bold mb-3">
                <i class="fa-solid fa-circle-check me-2"></i>
                @TempData["CheckoutSuccess"]
            </div>
        }

        <!-- NO CHECK-IN -->
        @if (!hasCheckedIn)
        {
            <div class="att-empty-state text-center">
                <p>You haven't checked in yet today.</p>

                @* manual attendance *@
                @* <a asp-action="CheckIn" class="att-btn att-btn-checkin">
                    <i class="fa-solid fa-play me-2"></i> Check In
                </a>
 *@

 @* Geo Attendance *@

                <button type="button"
                        onclick="geoCheckIn()"
                        class="att-btn att-btn-checkin">
                    <i class="fa-solid fa-play me-2"></i> Geo Check In
                </button>
            </div>
        }
        else
        {
            <!-- CHECK-IN CARD -->
            <div class="att-card neon-card mt-3">
                <div class="att-entry">
                    <div class="att-icon-wrapper bg-success-soft">
                        <i class="fa-solid fa-right-to-bracket text-success"></i>
                    </div>
                    <div>
                        <div class="att-label">CHECK-IN TIME</div>
                        <div class="att-value">@FormatTime(Model.InTime)</div>
                    </div>
                </div>
            </div>

            @if (hasCheckedOut)
            {
                <!-- CHECK-OUT CARD -->
                <div class="att-card neon-card mt-3">
                    <div class="att-entry">
                        <div class="att-icon-wrapper bg-danger-soft">
                            <i class="fa-solid fa-right-from-bracket text-danger"></i>
                        </div>
                        <div>
                            <div class="att-label">CHECK-OUT TIME</div>
                            <div class="att-value">@FormatTime(Model.OutTime)</div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- COUNTDOWN -->
                <div id="countdownContainer" class="att-card neon-card mt-3">
                    <div class="att-label text-center">
                        <i class="fa-solid fa-hourglass-half me-2 text-warning"></i>
                        Time Remaining (8-Hour 30-Minute shift)
                    </div>
                    <div id="countdown" class="countdown-digits">00:00:00</div>
                </div>

                <!-- CHECKOUT BUTTON -->
                <a href="#"
                   class="att-btn att-btn-checkout mt-3"
                   data-bs-toggle="modal"
                   data-bs-target="#checkoutModal">
                    <i class="fa-solid fa-stop me-2"></i> Check Out
                </a>
            }
        }
    </div>
</div>

<!-- CHECKOUT MODAL -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-danger">
                    <i class="fa-solid fa-circle-question me-2"></i> Confirm Checkout
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fs-5 mb-3">Are you sure you want to Check Out?</p>
            </div>
            <div class="modal-footer border-0 d-flex justify-content-between">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <a href="@Url.Action("CheckOut", "Attendance")"
                   class="btn btn-danger px-4">
                    Yes, Check Out
                </a>
            </div>
        </div>
    </div>
</div>

<!-- COUNTDOWN SCRIPT -->
<script>
    document.addEventListener("DOMContentLoaded", function () {

        if ('@(Model?.InTime == null ? "true" : "false")' === 'true') return;

        let label = document.getElementById("countdown");
        if (!label) return;

        let inTime = '@(Model?.InTime?.ToString() ?? "")';
        if (!inTime) return;

        let today = new Date();
        let shiftMinutes = (today.getDay() === 6) ? 420 : 510;

        let start = new Date(today.toISOString().split("T")[0] + "T" + inTime);
        let end = new Date(start.getTime() + shiftMinutes * 60000);

        function tick() {
            let diff = end - new Date();
            if (diff <= 0) {
                label.textContent = "00:00:00";
                return;
            }
            let h = Math.floor(diff / 3600000);
            let m = Math.floor((diff % 3600000) / 60000);
            let s = Math.floor((diff % 60000) / 1000);

            label.textContent =
                h.toString().padStart(2, '0') + ":" +
                m.toString().padStart(2, '0') + ":" +
                s.toString().padStart(2, '0');
        }

        tick();
        setInterval(tick, 1000);
    });
</script>

<!-- GEO CHECK-IN SCRIPT -->
<script>
    function geoCheckIn() {

        const errorDiv = document.getElementById("geoError");
        errorDiv.classList.add("d-none");

        if (!navigator.geolocation) {
            errorDiv.innerText = "Geolocation is not supported.";
            errorDiv.classList.remove("d-none");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            pos => {
                fetch('/Attendance/GeoCheckIn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude
                    })
                })
                .then(r => {
                    if (!r.ok) return r.text().then(t => { throw t; });
                    location.reload();
                })
                .catch(err => {
                    errorDiv.innerText = err;
                    errorDiv.classList.remove("d-none");
                });
            },
            () => {
                errorDiv.innerText = "Location permission denied.";
                errorDiv.classList.remove("d-none");
            }
        );
    }
</script>

<style>
    .att-page {
        display: flex;
        justify-content: center;
        padding: 25px 10px;
    }

    .att-container {
        max-width: 760px;
        width: 100%;
        background: #fff;
        border-radius: 24px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(0,0,0,.08);
    }

    .att-header {
        display: flex;
        gap: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .att-header-icon {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: linear-gradient(135deg,#fde68a,#f97316);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .att-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        max-width: 260px;
        margin: auto;
        padding: 12px;
        border-radius: 999px;
        font-weight: 700;
        color: white;
        text-decoration: none;
    }

    .att-btn-checkin {
        background: linear-gradient(135deg,#10b981,#059669);
    }

    .att-btn-checkout {
        background: linear-gradient(135deg,#ef4444,#b91c1c);
    }

    .geo-checkin-btn {
        background: linear-gradient(135deg,#2563eb,#1e40af);
    }

    .countdown-digits {
        font-size: 36px;
        font-weight: 900;
        color: #ef4444;
        text-align: center;
    }
</style>
