@model HRMS.Models.Attendance
@{
    ViewData["Title"] = "Attendance";
    var role = ViewBag.UserRole as string;
    if (role == "HR")
    {
        Layout = "~/Views/Shared/_HrLayout.cshtml";
    }
    else if (role == "VP" || role == "GM" || role == "Director")
    {
        Layout = "~/Views/Shared/_HrLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_EmployeeLayout.cshtml";
    }
    string FormatTime(object time)
    {
        if (time == null) return "—";

        if (time is TimeSpan ts)
            return DateTime.Today.Add(ts).ToString("dd MMM yyyy, hh:mm tt");

        if (time is DateTime dt)
            return dt.ToString("dd MMM yyyy, hh:mm tt");

        if (DateTime.TryParse(time.ToString(), out DateTime parsed))
            return parsed.ToString("dd MMM yyyy, hh:mm tt");

        return "—";
    }
}

<div class="att-page">
    <div class="att-container shadow-lg">

        <!-- HEADER -->
        <div class="att-header">
            <div class="att-header-icon">
                <i class="fa-solid fa-clock"></i>
            </div>
            <div>
                <h2 class="att-title">Attendance Panel</h2>
                <p class="att-subtitle">Track your work hours & check-in / check-out status</p>
            </div>
        </div>

        <!-- SUCCESS GREEN MESSAGE -->
        @if (TempData["CheckoutSuccess"] != null)
        {
            <div class="alert alert-success text-center fw-bold mb-3">
                <i class="fa-solid fa-circle-check me-2"></i>
                @TempData["CheckoutSuccess"]
            </div>
        }

        <!-- EARLY LEAVE RED MESSAGE -->
    <!-- Early Checkout -->
@if (TempData["EarlyCheckout"] != null && TempData["EarlyTime"] != null)
{
    <div class="alert alert-danger text-center fw-bold mb-3">
        <i class="fa-solid fa-triangle-exclamation me-2"></i>
        @TempData["EarlyCheckout"] — remaining @TempData["EarlyTime"]
    </div>
}

<!-- Late Checkout / Overtime -->
@if (TempData["LateCheckout"] != null && TempData["LateTime"] != null)
{
    <div class="alert alert-success text-center fw-bold mb-3">
        <i class="fa-solid fa-circle-check me-2"></i>
        @TempData["LateCheckout"] — extra @TempData["LateTime"]
    </div>
}





        <!-- SUCCESS CHECKOUT -->
        @if (TempData.Peek("CheckoutSuccess") != null)
        {
            <div class="alert alert-success text-center fw-bold mb-3">
                <i class="fa-solid fa-circle-check me-2"></i>
                @TempData.Peek("CheckoutSuccess")
            </div>
        }

        <!-- WHEN NO CHECK-IN -->
        @if (Model == null)
        {
            <div class="att-empty-state text-center">
                <p>You haven't checked in yet today.</p>
                <a asp-action="CheckIn" class="att-btn att-btn-checkin"><i class="fa-solid fa-play me-2"></i>Check In</a>
            </div>
        }
        else
        {
            <!-- CHECK-IN CARD -->
            <div class="att-card neon-card mt-3">
                <div class="att-entry">
                    <div class="att-icon-wrapper bg-success-soft">
                        <i class="fa-solid fa-right-to-bracket text-success"></i>
                    </div>
                    <div>
                        <div class="att-label">CHECK-IN TIME</div>
                        <div class="att-value">@FormatTime(Model.InTime)</div>
                    </div>
                </div>
            </div>

            <!-- IF CHECKED OUT -->
            @if (Model.OutTime != null)
            {
                <div class="att-card neon-card mt-3">
                    <div class="att-entry">
                        <div class="att-icon-wrapper bg-danger-soft">
                            <i class="fa-solid fa-right-from-bracket text-danger"></i>
                        </div>
                        <div>
                            <div class="att-label">CHECK-OUT TIME</div>
                            <div class="att-value">@FormatTime(Model.OutTime)</div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- COUNTDOWN -->
                <div id="countdownContainer" class="att-card neon-card mt-3">
                    <div class="att-label text-center">
                        <i class="fa-solid fa-hourglass-half me-2 text-warning"></i>
                        Time Remaining (8-Hour 30-Minute shift)
                    </div>
                    <div id="countdown" class="countdown-digits">00:00:00</div>
                </div>

                <!-- CHECKOUT BUTTON -->
                <a href="#" class="att-btn att-btn-checkout mt-3"
                   data-bs-toggle="modal" data-bs-target="#checkoutModal">
                    <i class="fa-solid fa-stop me-2"></i> Check Out
                </a>
            }
        }
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-danger">
                    <i class="fa-solid fa-circle-question me-2"></i> Confirm Checkout
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fs-5 mb-3">Are you sure you want to Check Out?</p>
                <img src="https://cdn-icons-png.flaticon.com/512/463/463612.png"
                     width="90" class="mb-3 opacity-75" />
            </div>
            <div class="modal-footer border-0 d-flex justify-content-between">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <a href="@Url.Action("Send", "DailyReport")" class="btn btn-danger px-4">
                    Yes, Check Out
                </a>
            </div>
        </div>
    </div>
</div>
@* <script>
    document.addEventListener("DOMContentLoaded", function () {

        let countdown = document.getElementById("countdownContainer");

        // Hide countdown if early / late message exists
        if (document.querySelector(".early-card") || document.querySelector(".late-card")) {
            if (countdown) countdown.style.display = "none";
            return;
        }

        let inTime  = '@(Model?.InTime?.ToString() ?? "")';
        let outTime = '@(Model?.OutTime?.ToString() ?? "")';

        // Hide if checked out or no check-in
        if (outTime !== "" || inTime === "") {
            if (countdown) countdown.style.display = "none";
            return;
        }

        let label = document.getElementById("countdown");
        if (!label) return;

        // ===============================
        // ✅ SHIFT LOGIC
        // ===============================
        let today = new Date();
        let day = today.getDay(); // Sun=0 ... Sat=6

        // Saturday = 7h (WOP), else 8.5h
        let shiftMinutes = (day === 6) ? 420 : 510;
        let shiftMs = shiftMinutes * 60 * 1000;

        // Build valid datetime
        let dateStr = today.toISOString().split("T")[0];
        let start = new Date(`${dateStr}T${inTime}`);
        let endTime = new Date(start.getTime() + shiftMs);

        function updateCountdown() {
            let now = new Date();
            let diff = endTime - now;

            if (diff <= 0) {
                label.textContent = "00:00:00";
                return;
            }

            let h = Math.floor(diff / 3600000);
            let m = Math.floor((diff % 3600000) / 60000);
            let s = Math.floor((diff % 60000) / 1000);

            label.textContent =
                h.toString().padStart(2, '0') + ":" +
                m.toString().padStart(2, '0') + ":" +
                s.toString().padStart(2, '0');
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    });
</script>  *@
<script>
    document.addEventListener("DOMContentLoaded", function () {

        let countdown = document.getElementById("countdownContainer");

        // Hide countdown if early / late message exists
        if (document.querySelector(".early-card") || document.querySelector(".late-card")) {
            if (countdown) countdown.style.display = "none";
            return;
        }

        let inTime  = '@(Model?.InTime?.ToString() ?? "")';
        let outTime = '@(Model?.OutTime?.ToString() ?? "")';

        // Hide if checked out or no check-in
        if (outTime !== "" || inTime === "") {
            if (countdown) countdown.style.display = "none";
            return;
        }

        let label = document.getElementById("countdown");
        if (!label) return;

        // ===============================
        // ✅ SHIFT LOGIC
        // ===============================
        let today = new Date();
        let day = today.getDay(); // Sun=0 ... Sat=6

        // Saturday = 7h (WOP), else 8.5h
        let shiftMinutes = (day === 6) ? 420 : 510;
        let shiftMs = shiftMinutes * 60 * 1000;

        // Build valid datetime
        let dateStr = today.toISOString().split("T")[0];
        let start = new Date(`${dateStr}T${inTime}`);
        let endTime = new Date(start.getTime() + shiftMs);

        function updateCountdown() {
            let now = new Date();
            let diff = endTime - now;

            if (diff <= 0) {
                label.textContent = "00:00:00";
                return;
            }

            let h = Math.floor(diff / 3600000);
            let m = Math.floor((diff % 3600000) / 60000);
            let s = Math.floor((diff % 60000) / 1000);

            label.textContent =
                h.toString().padStart(2, '0') + ":" +
                m.toString().padStart(2, '0') + ":" +
                s.toString().padStart(2, '0');
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    });
</script>



<style>
    /* EARLY / LATE Checkout cards */
    .status-card {
        width: 100%;
        padding: 14px 18px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 20px;
    }

    .early-card {
        background: #fde2e2;
        border-left: 6px solid #f87171;
        color: #b91c1c;
    }

    .late-card {
        background: #dcfce7;
        border-left: 6px solid #34d399;
        color: #065f46;
    }

    .status-icon {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

        .status-icon i {
            font-size: 18px;
        }

    .status-icon {
        background: #fee2e2;
        color: #dc2626;
    }

        .status-icon.late {
            background: #bbf7d0;
            color: #047857;
        }

    /* Layout */
    .att-page {
        display: flex;
        justify-content: center;
        padding: 25px 10px;
    }

    .att-container {
        width: 100%;
        max-width: 760px;
        background: #fff;
        border-radius: 24px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(0,0,0,.08);
    }

    .att-header {
        display: flex;
        gap: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .att-header-icon {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: linear-gradient(135deg,#fde68a,#f97316);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .att-title {
        font-size: 22px;
        font-weight: 800;
    }

    .att-subtitle {
        color: #6b7280;
        font-size: 13px;
    }

    /* Cards */
    .neon-card {
        background: #f9fafb;
        padding: 16px;
        border-radius: 18px;
        border: 1px solid #eee;
    }

    .att-entry {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .att-label {
        font-size: 12px;
        text-transform: uppercase;
        color: #6b7280;
    }

    .att-value {
        font-size: 18px;
        font-weight: 800;
    }

    /* Countdown */
    .countdown-digits {
        text-align: center;
        font-size: 36px;
        font-weight: 900;
        color: #ef4444;
        letter-spacing: 3px;
    }

    /* Buttons */
    .att-btn {
        display: block;
        width: 100%;
        max-width: 260px;
        margin: auto;
        padding: 12px;
        border-radius: 999px;
        font-size: 16px;
        font-weight: 700;
        color: white;
        text-decoration: none;
    }

    .att-btn-checkin {
        background: linear-gradient(135deg,#10b981,#059669);
    }

    .att-btn-checkout {
        background: linear-gradient(135deg,#ef4444,#b91c1c);
    }

    /* Modal */
    .custom-modal {
        border-radius: 18px;
        padding: 10px;
    }
</style>
