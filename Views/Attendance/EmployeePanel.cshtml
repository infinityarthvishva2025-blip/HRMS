@model HRMS.Models.Attendance
@{
    ViewData["Title"] = "Attendance";
    Layout = "~/Views/Shared/_EmployeeLayout.cshtml";

    string FormatTime(object time)
    {
        if (time == null) return "—";

        if (time is TimeSpan ts)
            return DateTime.Today.Add(ts).ToString("dd MMM yyyy, hh:mm tt");

        if (time is DateTime dt)
            return dt.ToString("dd MMM yyyy, hh:mm tt");

        if (DateTime.TryParse(time.ToString(), out DateTime parsed))
            return parsed.ToString("dd MMM yyyy, hh:mm tt");

        return "—";
    }
}

<div class="att-page">
    <div class="att-container shadow-lg">

        <!-- HEADER -->
        <div class="att-header">
            <div class="att-header-icon">
                <i class="fa-solid fa-clock"></i>
            </div>
            <div class="att-header-text">
                <h2 class="att-title">Attendance Panel</h2>
                <p class="att-subtitle">Track your work hours & check-in / check-out status</p>
            </div>
        </div>

        <!-- SUCCESS GREEN MESSAGE -->
        @if (TempData["CheckoutSuccess"] != null)
        {
            <div class="alert alert-success text-center fw-bold mb-3">
                <i class="fa-solid fa-circle-check me-2"></i>
                @TempData["CheckoutSuccess"]
            </div>
        }

        <!-- EARLY LEAVE RED MESSAGE -->
        @if (TempData["EarlyCheckout"] != null)
        {
            <div class="alert alert-danger text-center fw-bold mb-3">
                <i class="fa-solid fa-triangle-exclamation me-2"></i>
                @TempData["EarlyCheckout"]
            </div>
        }

        <!-- NO CHECK-IN -->
        @if (Model == null)
        {
            <div class="att-empty-state">
                <p class="att-empty-text mb-3">You haven't checked in yet today.</p>

                <a asp-action="CheckIn" class="att-btn att-btn-checkin">
                    <i class="fa-solid fa-play me-2"></i> Check In
                </a>
            </div>
        }
        else
        {
            <!-- CHECK-IN CARD -->
            <div class="att-card neon-card">
                <div class="att-entry">
                    <div class="att-icon-wrapper bg-success-soft">
                        <i class="fa-solid fa-right-to-bracket att-icon text-success"></i>
                    </div>
                    <div>
                        <div class="att-label">Check-in Time</div>
                        <div class="att-value">@FormatTime(Model.InTime)</div>
                    </div>
                </div>
            </div>

            <!-- IF CHECKED OUT SHOW CARD -->
            @if (Model.OutTime != null)
            {
                <div class="att-card neon-card mt-3">
                    <div class="att-entry">
                        <div class="att-icon-wrapper bg-danger-soft">
                            <i class="fa-solid fa-right-from-bracket att-icon text-danger"></i>
                        </div>
                        <div>
                            <div class="att-label">Check-out Time</div>
                            <div class="att-value">@FormatTime(Model.OutTime)</div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- COUNTDOWN -->
                <div id="countdownContainer" class="att-card neon-card mt-3">
                    <div class="att-label text-center">
                        <i class="fa-solid fa-hourglass-half me-2 text-warning"></i>
                        Time Remaining (8-Hour 30-Minutes shift including lunch break)
                    </div>
                    <div id="countdown" class="countdown-digits">00:00:00</div>
                </div>

                <!-- CHECKOUT BUTTON (OPENS MODAL) -->
                <a href="#" class="att-btn att-btn-checkout mt-3" data-bs-toggle="modal" data-bs-target="#checkoutModal">
                    <i class="fa-solid fa-stop me-2"></i> Check Out
                </a>
            }
        }
    </div>
</div>

<!-- CUSTOM CHECKOUT MODAL -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-danger">
                    <i class="fa-solid fa-circle-question me-2"></i> Confirm Checkout
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <p class="fs-5 mb-3">Are you sure you want to Check Out?</p>

                <img src="https://cdn-icons-png.flaticon.com/512/463/463612.png"
                     width="90" class="mb-3 opacity-75" />
            </div>

            <div class="modal-footer border-0 d-flex justify-content-between">
                <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <a href="@Url.Action("CheckOut", "Attendance")" class="btn btn-danger px-4">Yes, Check Out</a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        let success = document.querySelector(".alert-success");
        let early = document.querySelector(".alert-danger");
        let countdown = document.getElementById("countdownContainer");

        // If any checkout message → stop countdown + hide button
        if (success || early) {
            if (countdown) countdown.style.display = "none";
            return;
        }

        let inTime = '@(Model?.InTime?.ToString() ?? "")';
        let outTime = '@(Model?.OutTime?.ToString() ?? "")';

        if (outTime && outTime !== "") {
            countdown.style.display = "none";
            return;
        }

        if (!inTime || inTime === "") {
            countdown.style.display = "none";
            return;
        }

        // Countdown (8 hours + 30 minutes)
        let label = document.getElementById("countdown");
        let today = new Date();
        let dateStr = today.toISOString().split("T")[0];
        let start = new Date(dateStr + "T" + inTime);

        let endTime = new Date(start.getTime() + (8.5 * 60 * 60 * 1000)); // 8h 30m

        function updateCountdown() {
            let now = new Date();
            let diff = endTime - now;

            if (diff <= 0) {
                label.textContent = "00:00:00";
                return;
            }

            let h = Math.floor(diff / (1000 * 60 * 60));
            let m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            let s = Math.floor((diff % (1000 * 60)) / 1000);

            label.textContent =
                h.toString().padStart(2, '0') + ":" +
                m.toString().padStart(2, '0') + ":" +
                s.toString().padStart(2, '0');
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    });
</script>

<style>
    .modal-backdrop.show {
        opacity: .2 !important;
    }

    .custom-modal {
        border-radius: 18px;
        padding: 10px;
        box-shadow: 0 10px 35px rgba(0,0,0,0.25);
        animation: popup 0.25s ease-out;
    }

    @@keyframes popup {
        from {
            transform: scale(0.8);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .custom-modal .btn-danger {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
        border: none;
    }

    .custom-modal .btn-secondary {
        background: #e5e7eb;
        color: #111;
        border: none;
    }

    .att-page {
        display: flex;
        justify-content: center;
        padding: 25px 10px;
    }

    .att-container {
        width: 100%;
        max-width: 760px;
        background: #fff;
        border-radius: 24px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(0,0,0,.08);
    }

    .att-header {
        display: flex;
        align-items: center;
        gap: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .att-header-icon {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: linear-gradient(135deg,#fde68a,#f97316);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .att-title {
        font-weight: 800;
        font-size: 22px;
    }

    .att-subtitle {
        color: #6b7280;
        font-size: 13px;
    }

    .neon-card {
        background: #f9fafb;
        padding: 16px;
        border-radius: 18px;
        border: 1px solid #eee;
    }

    .att-entry {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .att-label {
        text-transform: uppercase;
        font-size: 12px;
        color: #6b7280;
    }

    .att-value {
        font-size: 18px;
        font-weight: 800;
    }

    .bg-success-soft {
        background: #dcfce7;
    }

    .bg-danger-soft {
        background: #fee2e2;
    }

    .countdown-digits {
        text-align: center;
        font-size: 35px;
        font-weight: 900;
        color: #ef4444;
        letter-spacing: 4px;
        animation: glow 1.4s infinite alternate;
    }
    @@keyframes glow {
        from {
            text-shadow: 0 0 6px rgba(239,68,68,.5);
        }

        to {
            text-shadow: 0 0 16px rgba(239,68,68,1);
        }
    }

    .att-btn {
        display: block;
        width: 100%;
        max-width: 260px;
        margin: auto;
        padding: 12px;
        border-radius: 999px;
        font-size: 16px;
        font-weight: 700;
        text-align: center;
        color: white;
        text-decoration: none;
    }

    .att-btn-checkin {
        background: linear-gradient(135deg,#10b981,#059669);
    }

    .att-btn-checkout {
        background: linear-gradient(135deg,#ef4444,#b91c1c);
    }
</style>
