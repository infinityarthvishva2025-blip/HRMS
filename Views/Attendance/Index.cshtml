@model IEnumerable<HRMS.ViewModels.AttendanceIndexVm>

@{
    ViewData["Title"] = "Attendance Records";
    Layout = "~/Views/Shared/_HrLayout.cshtml";

    // Safely get employee list
    List<HRMS.Models.Employee> employees =
        ViewBag.EmployeeList as List<HRMS.Models.Employee>
        ?? new List<HRMS.Models.Employee>();
}

<div class="container py-4">

    <h2 class="fw-bold text-primary mb-4">
        <i class="fa-solid fa-filter me-2"></i> Attendance Filters
    </h2>

    <!-- FILTER FORM -->
    <form method="get" class="row g-3 shadow-sm bg-white p-4 rounded mb-4">

        <!-- Search -->
        <div class="col-md-3">
            <label class="form-label fw-bold">Search</label>
            <input type="text"
                   name="search"
                   class="form-control"
                   value="@ViewBag.Search"
                   placeholder="Employee name or code" />
        </div>

        <!-- From Date -->
        <div class="col-md-2">
            <label class="form-label fw-bold">From Date</label>
            <input type="date"
                   name="fromDate"
                   class="form-control"
                   value="@ViewBag.FromDate" />
        </div>

        <!-- To Date -->
        <div class="col-md-2">
            <label class="form-label fw-bold">To Date</label>
            <input type="date"
                   name="toDate"
                   class="form-control"
                   value="@ViewBag.ToDate" />
        </div>

        <!-- Status -->
       <!-- Status -->
<div class="col-md-2">
    <label class="form-label fw-bold">Status</label>
    <select name="status" class="form-select">
                <option value="All" selected="@(ViewBag.Status == "All")">All</option>
                <option value="Completed" selected="@(ViewBag.Status == "Completed")">Completed</option>
                <option value="NotCheckedOut" selected="@(ViewBag.Status == "NotCheckedOut")">Not Checked Out</option>

    </select>
</div>


        <!-- Buttons -->
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-50 me-2">
                <i class="fa-solid fa-search me-1"></i> Apply
            </button>

            <button formaction="/Attendance/ExportFiltered"
                    formmethod="get"
                    class="btn btn-success w-50">
                <i class="fa-solid fa-file-excel me-1"></i> Export
            </button>
        </div>

    </form>

    <!-- TABLE -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">

            <table class="table table-bordered table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Employee Code</th>
                        <th>Name</th>
                        <th>Check In</th>
                        <th>Check Out</th>
                        <th>Total Hours</th>
                        <th>Status</th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model == null || !Model.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4 text-danger fw-bold">
                                No records found...
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var a in Model)
                        {
                            var emp = employees.FirstOrDefault(e => e.EmployeeCode == a.Emp_Code);

                            // Total Hours
                            string total_Hours = "--";
                            if (a.InTime.HasValue && a.OutTime.HasValue)
                            {
                                var diff = a.OutTime.Value - a.InTime.Value;
                                total_Hours = $"{diff.Hours}h {diff.Minutes}m";
                            }

                            // Attendance Status
                            string attStatus =
                                !a.InTime.HasValue ? "Absent"
                                : !a.OutTime.HasValue ? "Not Checked Out"
                                : "Present";

                            <tr>
                                <td>@a.Emp_Code</td>
                                <td>@(emp?.Name ?? "--")</td>

                                <td>@(a.InTime?.ToString(@"hh\:mm") ?? "--")</td>
                                <td>@(a.OutTime?.ToString(@"hh\:mm") ?? "--")</td>

                                <td>@total_Hours</td>

                                <td>
                                    @if (attStatus == "Absent")
                                    {
                                        <span class="badge bg-danger">Absent</span>
                                    }
                                    else if (attStatus == "Not Checked Out")
                                    {
                                        <span class="badge bg-warning text-dark">Not Checked Out</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Present</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>

            </table>

        </div>
    </div>
</div>

<style>
    .badge {
        padding: 6px 10px;
        font-size: 0.85rem;
    }
</style>
