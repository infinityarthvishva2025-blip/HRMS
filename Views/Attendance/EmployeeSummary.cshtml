@model HRMS.Models.ViewModels.EmployeeAttendanceSummaryViewModel

@{
    ViewData["Title"] = "Attendance Summary";
    Layout = "_EmployeeLayout";
}

<div class="container py-4">
    <h2 class="fw-bold text-primary mb-4">
        Attendance Summary — @Model.Employee.Name (@Model.Employee.EmployeeCode)
    </h2>

    <!-- Filter -->
    <form method="get" asp-action="EmployeeSummary" class="row g-3 mb-4">
        <input type="hidden" name="employeeId" value="@Model.Employee.Id" />

        <div class="col-md-4">
            <label class="form-label fw-bold">From Date</label>
            <input type="date" name="from" class="form-control"
                   value="@Model.FromDate.ToString("yyyy-MM-dd")" />
        </div>

        <div class="col-md-4">
            <label class="form-label fw-bold">To Date</label>
            <input type="date" name="to" class="form-control"
                   value="@Model.ToDate.ToString("yyyy-MM-dd")" />
        </div>

        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100">
                <i class="fa-solid fa-filter me-1"></i> Filter
            </button>
        </div>
    </form>

    <!-- Daily Attendance Log -->
    <h4 class="fw-bold mb-3">Daily Attendance Log</h4>

    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Check In</th>
                    <th>Check Out</th>
                    <th>Working Hours</th>
                    <th>Status</th>
                    <th>Ticket</th>
                </tr>
            </thead>

            <!-- 🔹 REQUIRED FOR PAGINATION -->
            <tbody id="tableBody">
                @foreach (var a in Model.AttendanceRecords)
                {
                    <tr>
                        <td>@a.Date.ToString("dd-MMM-yyyy")</td>

                        <td>
                            @(a.InTime.HasValue
                                                    ? DateTime.Today.Add(a.InTime.Value).ToString("hh:mm tt")
                                                    : "--")
                                                       </td>

                        <td>
                            @(a.OutTime.HasValue
                                                    ? DateTime.Today.Add(a.OutTime.Value).ToString("hh:mm tt")
                                                    : "--")
                    </td>

                        <td>
                        @if (a.InTime.HasValue && a.OutTime.HasValue)
                            {
                                var diff = a.OutTime.Value - a.InTime.Value;
                                @($"{diff.Hours}h {diff.Minutes}m")
                            }
                            else
                            {
                                <span>--</span>
                            }
                        </td>

                        <td>
                            @if (a.Status == "P")
                            {
                                <span class="badge bg-success">Present</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Absent</span>
                            }
                        </td>

                        <td>
                            @if (!a.CorrectionRequested)
                            {
                                <a asp-controller="Attendance"
                                   asp-action="RequestCorrection"
                                   asp-route-empCode="@a.Emp_Code"
                                   asp-route-date="@a.Date.ToString("yyyy-MM-dd")"
                                   asp-route-employeeId="@Model.Employee.Id"
                                   class="btn btn-warning btn-sm">
                                    Request
                                </a>
                            }
                            else
                            {
                                <span class="badge bg-info">@a.CorrectionStatus</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- 🔽 PAGINATION BAR -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <span id="pageInfo" class="text-muted"></span>

        <nav>
            <ul class="pagination mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<style>
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }

    .pagination .page-link {
        cursor: pointer;
        border-radius: 6px;
        margin: 0 2px;
    }

    table th, table td {
        vertical-align: middle;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const rowsPerPage = 10;
        const tableBody = document.getElementById("tableBody");
        const rows = Array.from(tableBody.querySelectorAll("tr"));

        const pagination = document.getElementById("pagination");
        const pageInfo = document.getElementById("pageInfo");

        let currentPage = 1;
        const totalPages = Math.ceil(rows.length / rowsPerPage);

        function showPage(page) {
            currentPage = page;

            rows.forEach((row, index) => {
                row.style.display =
                    index >= (page - 1) * rowsPerPage &&
                    index < page * rowsPerPage ? "" : "none";
            });

            pageInfo.innerText = `Page ${currentPage} of ${totalPages || 1}`;
            renderPagination();
        }

        function renderPagination() {
            pagination.innerHTML = "";

            // ◀ PREVIOUS
            const prev = document.createElement("li");
            prev.className = "page-item " + (currentPage === 1 ? "disabled" : "");
            prev.innerHTML = `<a class="page-link">&lsaquo;</a>`;
            prev.onclick = () => {
                if (currentPage > 1) showPage(currentPage - 1);
            };
            pagination.appendChild(prev);

            // PAGE NUMBERS
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement("li");
                li.className = "page-item " + (i === currentPage ? "active" : "");
                li.innerHTML = `<a class="page-link">${i}</a>`;
                li.onclick = () => showPage(i);
                pagination.appendChild(li);
            }

            // ▶ NEXT
            const next = document.createElement("li");
            next.className = "page-item " + (currentPage === totalPages ? "disabled" : "");
            next.innerHTML = `<a class="page-link">&rsaquo;</a>`;
            next.onclick = () => {
                if (currentPage < totalPages) showPage(currentPage + 1);
            };
            pagination.appendChild(next);
        }

        if (rows.length > 0) showPage(1);
    });
</script>
