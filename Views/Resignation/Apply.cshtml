@model ResignationApplyVM
@inject IHttpContextAccessor HttpContextAccessor

@{
    var role = HttpContextAccessor.HttpContext?.Session.GetString("Role") ?? "Employee";
    role = string.IsNullOrWhiteSpace(role) || role == "-" ? "Employee" : role;

    Layout = (role == "HR" || role == "GM" || role == "VP" || role == "Director")
        ? "~/Views/Shared/_HrLayout.cshtml"
        : "~/Views/Shared/_EmployeeLayout.cshtml";
}

<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-xl-7 col-lg-8 col-md-10 col-sm-12">

            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-box-arrow-right me-2"></i>
                        Resignation Application
                    </h5>
                </div>

                <div class="card-body">
                    <form asp-action="Apply"
                          asp-controller="Resignation"
                          method="post"
                          enctype="multipart/form-data">

                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                        </div>

                        <!-- Resignation Date -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Resignation Date</label>
                            <input asp-for="ResignationDate"
                                   type="date"
                                   class="form-control"
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            <span asp-validation-for="ResignationDate" class="text-danger small"></span>
                        </div>

                        <!-- Notice Period -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Notice Period</label>
                            <input class="form-control" value="@($"{Model.NoticePeriodDays} days")" readonly />
                            @if (!Model.IsProvisionalCompleted)
                            {
                                <small class="text-warning">
                                    You are under provisional period. No notice period applicable.
                                </small>
                            }
                        </div>

                        <!-- Suggested -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                Suggested Last Working Day <span class="text-muted">(as per policy)</span>
                            </label>

                            <input type="hidden" asp-for="SuggestedLastWorkingDay" id="SuggestedLwdHidden" />

                            <div class="form-control bg-light">
                                <strong id="SuggestedLwdText">
                                    @Model.SuggestedLastWorkingDay.ToString("dd-MMM-yyyy")
                                </strong>
                            </div>
                        </div>

                        <!-- Reason -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Reason</label>
                            <select asp-for="ReasonCode" class="form-select" required>
                                <option value="">-- Select Reason --</option>
                                <option value="Better Opportunity">Better Opportunity</option>
                                <option value="Higher Studies">Higher Studies</option>
                                <option value="Personal">Personal</option>
                                <option value="Health">Health</option>
                                <option value="Other">Other</option>
                            </select>
                            <span asp-validation-for="ReasonCode" class="text-danger small"></span>
                        </div>

                        <!-- Details -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Details / Remarks</label>
                            <textarea asp-for="DetailedReason"
                                      class="form-control"
                                      rows="3"
                                      placeholder="Optional explanation..."></textarea>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-send me-1"></i>
                                Submit Resignation
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        const resignationInput = document.querySelector('[name="ResignationDate"]');
        const suggestedHidden = document.getElementById('SuggestedLwdHidden');
        const suggestedText = document.getElementById('SuggestedLwdText');

        function calculateSuggestedDate() {
            if (!resignationInput.value) return;

            const noticeDays = @Model.NoticePeriodDays;
            const resDate = new Date(resignationInput.value);
            const lwd = new Date(resDate);
            lwd.setDate(lwd.getDate() + noticeDays);

            const yyyy = lwd.getFullYear();
            const mm = String(lwd.getMonth() + 1).padStart(2, '0');
            const dd = String(lwd.getDate()).padStart(2, '0');
            suggestedHidden.value = `${yyyy}-${mm}-${dd}`;

            suggestedText.innerText = lwd.toLocaleDateString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
        }

        calculateSuggestedDate();
        resignationInput.addEventListener('change', calculateSuggestedDate);
    </script>
}
