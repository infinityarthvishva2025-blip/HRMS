@model HRMS.Models.GurukulVideo

@{
    ViewData["Title"] = "Play Video";
    Layout = "_EmployeeLayout";

    var prog = (HRMS.Models.GurukulProgress?)ViewBag.Progress;
    var backUrl = Url.Action("Index", "Gurukul");

    // NEW → All videos from same TitleGroup
    var videoList = ViewBag.VideoList as List<HRMS.Models.GurukulVideo>;
}

<style>
    .video-header {
        padding: 10px 0;
        border-bottom: 1px solid #ddd;
        margin-bottom: 15px;
    }

    .description-box {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        margin-bottom: 15px;
    }

    #closeBtn:disabled {
        background-color: gray !important;
        border-color: gray !important;
        cursor: not-allowed;
    }
</style>

<div class="container mt-3">

    <!-- ===================== TITLE ===================== -->
    <div class="video-header">
        <h3>@Model.Title</h3>
    </div>

    <!-- ================= DESCRIPTION ================= -->
    @if (!string.IsNullOrEmpty(Model.Description))
    {
        <div class="description-box">
            @Model.Description
        </div>
    }

    <!-- ================= VIDEO DROPDOWN ================= -->
    <div class="mb-3">
        <label><b>Select Video:</b></label>
        <select class="form-control" onchange="location.href='/Gurukul/Details/' + this.value;">
            @foreach (var v in videoList)
            {
                <option value="@v.Id" selected="@(v.Id == Model.Id)">
                    @v.Title
                </option>
            }
        </select>
    </div>


    <!-- ===================== VIDEO PLAYER ===================== -->
    @if (Model.IsExternal)
    {
        <!-- External YouTube / Vimeo / Website -->
        <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;">
            <iframe id="gurukulIframe"
                    src="@Model.VideoPath"
                    style="position:absolute;top:0;left:0;width:100%;height:100%;"
                    frameborder="0" allowfullscreen>
            </iframe>
        </div>
    }
    else
    {
        <!-- Internal MP4 -->
        <video id="gurukulPlayer" width="100%" controls>
            <source src="@Model.VideoPath" type="video/mp4">
            Your browser does not support video playback.
        </video>
    }


    <!-- ===================== STATUS + CLOSE BUTTON ===================== -->
    <div class="mt-3">
        <span id="statusBadge">
            @if (prog != null && prog.IsCompleted)
            {
                <span class="badge bg-success">Completed</span>
            }
            else
            {
                <span class="badge bg-warning text-dark">Pending</span>
            }
        </span>

        <button id="closeBtn" class="btn btn-primary ms-2" disabled>Close Video</button>
    </div>

</div>

<!-- ===================== SCRIPTS ===================== -->
<script>

    let completed = @((prog != null && prog.IsCompleted).ToString().ToLower());
    const closeBtn = document.getElementById("closeBtn");
    if (completed) closeBtn.disabled = false;

    // -------------------- MARK COMPLETE --------------------
    function markComplete() {
        fetch('@Url.Action("MarkComplete", "Gurukul")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'videoId=@Model.Id'
        })
        .then(r => r.json())
        .then(j => {
            if (j.success) {
                document.getElementById("statusBadge").innerHTML =
                    '<span class="badge bg-success">Completed</span>';
                closeBtn.disabled = false;
            }
        });
    }


    // -------------------- INTERNAL VIDEO END --------------------
    const video = document.getElementById("gurukulPlayer");

    if (video) {
        video.addEventListener("ended", markComplete);
    }


    // -------------------- EXTERNAL VIDEO LOGIC --------------------
    const iframe = document.getElementById("gurukulIframe");

    if (iframe) {
        iframe.addEventListener("load", function () {

            if (!completed) {
                // Auto-complete for YouTube (5s fallback)
                setTimeout(() => {
                    markComplete();
                }, 5000);
            }

        });
    }


    // -------------------- CLOSE BUTTON --------------------
    closeBtn.addEventListener("click", function () {
        if (video) video.pause();
        if (iframe) iframe.src = "";
        window.location.href = '@backUrl';
    });

</script>
