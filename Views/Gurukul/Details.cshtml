@model HRMS.Models.GurukulVideo

@{
    ViewData["Title"] = "Play Video";
    Layout = "_EmployeeLayout";

    var prog = (HRMS.Models.GurukulProgress?)ViewBag.Progress;
    var backUrl = Url.Action("Index", "Gurukul");
    var videoList = ViewBag.VideoList as List<HRMS.Models.GurukulVideo>;
}

<style>

    .page-title {
        font-size: 28px;
        font-weight: 800;
        color: #1a237e;
        margin-bottom: 25px;
    }

    .video-card {
        background: #fff;
        padding: 25px;
        border-radius: 16px;
        border: 1px solid #e5e7f3;
        box-shadow: 0 6px 22px rgba(0,0,0,0.06);
    }

    .description-box {
        padding: 15px;
        background: #f7f9ff;
        border-radius: 12px;
        border: 1px solid #e3e6fb;
        margin-bottom: 20px;
        font-size: 15px;
        line-height: 22px;
    }

    .custom-select {
        border-radius: 10px;
        padding: 10px 14px;
        border: 1px solid #cfd3ef;
        background: #f8f9ff;
        font-size: 15px;
    }

    .video-wrapper {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 22px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .status-wrap {
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .btn-closevideo:disabled {
        background-color: #8c8c8c !important;
        border-color: #8c8c8c !important;
        cursor: not-allowed;
    }

    .btn-closevideo {
        border-radius: 8px;
        padding: 8px 18px;
        font-weight: 600;
        background: #3949ab;
        border: none;
        color: white;
    }

</style>


<div class="container mt-3">

    <div class="video-card">

        <h2 class="page-title">@Model.Title</h2>

        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <div class="description-box">
                @Model.Description
            </div>
        }

        <label class="fw-semibold">Select Video</label>
        <select class="form-control custom-select mb-3"
                onchange="location.href='/Gurukul/Details/' + this.value;">

            @foreach (var v in videoList)
            {
                var isSelected = v.Id == Model.Id ? "selected" : "";

                <option value="@v.Id" selected="@isSelected">
                    @v.Title
                </option>
            }

        </select>

        <div class="video-wrapper">
            @if (Model.IsExternal)
            {
                <div style="position:relative;padding-bottom:56.25%;height:0;">
                    <iframe id="gurukulIframe"
                            src="@Model.VideoPath"
                            style="position:absolute;top:0;left:0;width:100%;height:100%;"
                            frameborder="0"
                            allowfullscreen>
                    </iframe>
                </div>
            }
            else
            {
                <video id="gurukulPlayer" width="100%" controls style="border-radius: 12px;">
                    <source src="@Model.VideoPath" type="video/mp4" />
                    Your browser does not support video playback.
                </video>
            }
        </div>

        <div class="status-wrap">
            <span id="statusBadge">
                @if (prog?.IsCompleted == true)
                {
                    <span class="badge bg-success px-3 py-2">Completed</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark px-3 py-2">Pending</span>
                }
            </span>

            <button id="closeBtn" class="btn-closevideo" disabled>
                Close Video
            </button>
        </div>

    </div>

</div>



<!-- ===================== SCRIPT ===================== -->
<script>

    let completed = @((prog != null && prog.IsCompleted).ToString().ToLower());
    const closeBtn = document.getElementById("closeBtn");

    if (completed) closeBtn.disabled = false;

    function markComplete() {
        fetch('@Url.Action("MarkComplete", "Gurukul")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'videoId=@Model.Id'
        })
        .then(r => r.json())
        .then(j => {
            if (j.success) {
                document.getElementById("statusBadge").innerHTML =
                    '<span class="badge bg-success px-3 py-2">Completed</span>';
                closeBtn.disabled = false;
            }
        });
    }

    /* =====================================================
       🛑 BLOCK FORWARDING (Prevent Video Skipping)
       ===================================================== */
    const video = document.getElementById("gurukulPlayer");

    if (video) {
        let lastTime = 0;

        video.addEventListener("timeupdate", function () {
            if (video.currentTime - lastTime > 1.5) {
                video.currentTime = lastTime;   // block forward
            }
            lastTime = video.currentTime;
        });

        video.addEventListener("ended", markComplete);
    }

    /* =====================================================
       EXTERNAL VIDEO AUTO-COMPLETE (5 sec fallback)
       ===================================================== */
    const iframe = document.getElementById("gurukulIframe");

    if (iframe) {
        iframe.addEventListener("load", function () {
            if (!completed) {
                setTimeout(() => markComplete(), 5000);
            }
        });
    }

    /* =====================================================
       CLOSE BUTTON LOGIC
       ===================================================== */
    closeBtn.addEventListener("click", function () {
        if (video) video.pause();
        if (iframe) iframe.src = "";
        window.location.href = '@backUrl';
    });

</script>
