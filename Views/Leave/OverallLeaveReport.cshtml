@model IEnumerable<Leave>

@{
    ViewData["Title"] = "Leave Dashboard";
    Layout = "_HrLayout";
    var currentYear = DateTime.Now.Year;
}
<style>
    /* 🔹 Center & resize leave report chart */
    .chart-wrapper {
        width: 60%; /* 👈 controls width */
        max-width: 600px; /* 👈 prevents too large */
    }

        .chart-wrapper canvas {
            height: 260px !important; /* 👈 smaller height */
        }

 
    /* Pill Tabs Styling */
    .pill-tabs {
        display: flex;
        gap: 8px;
        background: white;
        padding: 6px;
        border-radius: 50px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .pill-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 20px;
        border: none;
        background: transparent;
        color: #666;
        font-weight: 500;
        border-radius: 50px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

        .pill-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .pill-btn.active {
            background: #0077c2;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 119, 194, 0.2);
        }

            .pill-btn.active:hover {
                background: #0066a8;
            }

    .badge-count {
        background: rgba(255,255,255,0.2);
        color: inherit;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .pill-btn.active .badge-count {
        background: rgba(255,255,255,0.3);
    }

    .pill-btn:not(.active) .badge-count {
        background: #e0e0e0;
        color: #666;
    }
</style>


<div class="container mt-4">
    <h3 class="mb-3">
        <i class="fa-solid fa-plane-departure icon-leave"></i>
        <span> Leave Management</span>
    </h3>

    <!-- 🔷 CARDS -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <h5>HR Pending</h5>
                <h3 id="hrPending" class="text-warning">0</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <h5>Manager Pending</h5>
                <h3 id="managerPending" class="text-primary">0</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <h5>VP Pending</h5>
                <h3 id="vpPending" class="text-danger">0</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <h5>Director Pending</h5>
                <h3 id="directorPending" class="text-danger">0</h3>
            </div>
        </div>
    </div>

    <!-- 🔷 STATUS TABS -->
    <div class="d-flex justify-content-end mb-3">
        <div class="pill-tabs" id="statusTabs">
            <button class="pill-btn active" data-status="All">
                <span class="badge-count">@Model.Count()</span>All
            </button>
            <button class="pill-btn" data-status="Pending">
                <span class="badge-count" id="pendingCount">0</span>Pending
            </button>
            <button class="pill-btn" data-status="Approved">
                <span class="badge-count" id="approvedCount">0</span>Approved
            </button>
            <button class="pill-btn" data-status="Rejected">
                <span class="badge-count" id="rejectedCount">0</span>Rejected
            </button>
        </div>
    </div>

    <!-- 🔍 SEARCH -->
    <div class="d-flex justify-content-end mb-2">
        <input type="text" id="tableSearch"
               class="form-control w-25"
               placeholder="Search employee / type / status..." />
    </div>

    <!-- 📋 TABLE -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Employee Name</th>
                    <th>Category</th>
                    <th>Leave Type</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Total Days</th>
                    <th>Status</th>
                </tr>
            </thead>

            <tbody id="tableBody">
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@($"{item.Employee?.EmployeeCode} - {item.Employee?.Name}")</td>
                        <td>@item.Category</td>
                        <td>@item.LeaveType</td>
                        <td>@item.StartDate.ToString("dd-MM-yyyy")</td>
                        <td>@(item.EndDate?.ToString("dd-MM-yyyy") ?? "N/A")</td>
                        <td>@item.TotalDays</td>
                        <td>@item.OverallStatus</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <span id="pageInfo" class="text-muted"></span>
        <nav>
            <ul class="pagination mb-0" id="pagination"></ul>
        </nav>
    </div>

    <!-- ✅ NEW LEAVE REPORT (ATTENDANCE STYLE) -->
    <div class="card shadow-sm mb-4 mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Monthly Leave Report</h5>
                <span class="badge bg-secondary" id="selectedPeriod"></span>
            </div>

            <!-- 🔹 CENTERED SMALL CHART -->
            <div class="d-flex justify-content-center">
                <div class="chart-wrapper">
                    <canvas id="leaveBarChart"></canvas>
                </div>
            </div>

            <div class="d-flex justify-content-around mt-3 fw-bold">
                <span class="text-success">Approved: <span id="approvedLbl">0</span></span>
                <span class="text-warning">Pending: <span id="pendingLbl">0</span></span>
                <span class="text-danger">Rejected: <span id="rejectedLbl">0</span></span>
            </div>

            <div class="d-flex justify-content-center gap-2 mt-4">
                <select id="monthSelect" class="form-select w-auto">
                    @for (int m = 1; m <= 12; m++)
                    {
                        <option value="@m">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
                    }
                </select>

                <select id="yearSelect" class="form-select w-auto">
                    @for (int y = currentYear - 2; y <= currentYear + 1; y++)
                    {
                        <option value="@y" selected="@(y == currentYear)">@y</option>
                    }
                </select>

                <button class="btn btn-primary" id="viewReportBtn">View</button>
            </div>
        </div>
    </div>

</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const leaveData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.Select(l => new {
            date = l.StartDate,
            status = l.OverallStatus
        })
    ));

    let chart;

    function loadLeaveReport(month, year) {
        let approved = 0, pending = 0, rejected = 0;

        leaveData.forEach(l => {
            const d = new Date(l.date);
            if (d.getMonth() + 1 === month && d.getFullYear() === year) {
                if (l.status === "Approved") approved++;
                else if (l.status === "Pending") pending++;
                else if (l.status === "Rejected") rejected++;
            }
        });

        document.getElementById("approvedLbl").innerText = approved;
        document.getElementById("pendingLbl").innerText = pending;
        document.getElementById("rejectedLbl").innerText = rejected;
        document.getElementById("selectedPeriod").innerText =
            new Date(year, month - 1).toLocaleString('default', { month: 'long', year: 'numeric' });

        if (chart) chart.destroy();

        chart = new Chart(document.getElementById("leaveBarChart"), {
            type: 'bar',
            data: {
                labels: ['Approved', 'Pending', 'Rejected'],
                datasets: [{
                    data: [approved, pending, rejected],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderRadius: 8
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    document.getElementById("viewReportBtn").addEventListener("click", () => {
        loadLeaveReport(
            parseInt(monthSelect.value),
            parseInt(yearSelect.value)
        );
    });

    // Initial load
    const now = new Date();
    monthSelect.value = now.getMonth() + 1;
    loadLeaveReport(now.getMonth() + 1, now.getFullYear());
</script>
    <!-- 🔢 SEARCH + PAGINATION + TABS -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rowsPerPage = 10;
            const tableBody = document.getElementById("tableBody");
            const searchBox = document.getElementById("tableSearch");
            const pagination = document.getElementById("pagination");
            const pageInfo = document.getElementById("pageInfo");
            const tabs = document.querySelectorAll("#statusTabs .pill-btn");

        const allRows = Array.from(tableBody.querySelectorAll("tr"));
            let filteredRows = [...allRows];
            let currentPage = 1;
            let activeStatus = "All";

        // Function to update badge counts
            function updateBadgeCounts() {
                const pendingCount = allRows.filter(row =>
                    row.children[6]?.innerText.trim() === "Pending").length;
                const approvedCount = allRows.filter(row =>
                    row.children[6]?.innerText.trim() === "Approved").length;
                const rejectedCount = allRows.filter(row =>
                    row.children[6]?.innerText.trim() === "Rejected").length;

            document.getElementById('pendingCount').textContent = pendingCount;
                document.getElementById('approvedCount').textContent = approvedCount;
                document.getElementById('rejectedCount').textContent = rejectedCount;
            }

        function applyFilters() {
                const q = searchBox.value.toLowerCase().trim();

            filteredRows = allRows.filter(row => {
                    const textMatch = row.innerText.toLowerCase().includes(q);
                    const statusCell = row.children[6]?.innerText.trim(); // Status column
                    const statusMatch = activeStatus === "All" || statusCell === activeStatus;

                return textMatch && statusMatch;
                });

            currentPage = 1;
                paginate();
            }

        function paginate() {
                const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;

            allRows.forEach(r => r.style.display = "none");

            filteredRows.forEach((r, i) => {
                    if (i >= (currentPage - 1) * rowsPerPage &&
                        i < currentPage * rowsPerPage) {
                        r.style.display = "";
                    }
                });

            pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
                renderPagination(totalPages);
            }

        function renderPagination(totalPages) {
                pagination.innerHTML = "";

            const prev = `<li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                    <a class="page-link">&lsaquo;</a></li>`;
                pagination.insertAdjacentHTML("beforeend", prev);

            for (let i = 1; i <= totalPages; i++) {
                    pagination.insertAdjacentHTML("beforeend",
                        `<li class="page-item ${i === currentPage ? "active" : ""}">
                            <a class="page-link">${i}</a></li>`);
                }

            const next = `<li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
                    <a class="page-link">&rsaquo;</a></li>`;
                pagination.insertAdjacentHTML("beforeend", next);

            [...pagination.children].forEach((li, i) => {
                    li.onclick = () => {
                        if (i === 0 && currentPage > 1) currentPage--;
                        else if (i === pagination.children.length - 1 && currentPage < totalPages) currentPage++;
                        else if (i > 0 && i < pagination.children.length - 1) currentPage = i;
                        paginate();
                    };
                });
            }

        // 🔍 Search
            searchBox.addEventListener("keyup", applyFilters);

        // 🗂 Tabs
            tabs.forEach(tab => {
                tab.addEventListener("click", function () {
                    tabs.forEach(t => t.classList.remove("active"));
                    this.classList.add("active");
                    activeStatus = this.dataset.status;
                    applyFilters();
                });
            });

        // Update badge counts initially
            updateBadgeCounts();
            applyFilters();
        });
    </script>
     <!-- 🔄 PENDING COUNTS -->
    <script>
        function loadPendingCounts() {
            debugger;
            fetch('/Leave/GetPendingCountsall')
                .then(res => res.json())
                .then(data => {
                    managerPending.textContent = data.managerPending;
                    hrPending.textContent = data.hrPending;
                    VPPending.textContent=data.VPPending;
                    directorPending.textContent = data.directorPending;
                });
        }
        loadPendingCounts();
    </script>
}

@* @model IEnumerable<Leave>

@{
    ViewData["Title"] = "Leave Dashboard";
    Layout = "_HrLayout";
}

<div class="container mt-4">
    <h3 class="mb-3">
        <i class="fa-solid fa-plane-departure icon-leave"></i>
        <span> Leave Management</span>
    </h3>

    <!-- 🔷 CARDS -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm p-3 text-center border-left-primary">
                <h5>HR Pending</h5>
                <h3 id="hrPending" class="text-warning">0</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm p-3 text-center border-left-warning">
                <h5>Manager Pending</h5>
                <h3 id="managerPending" class="text-primary">0</h3>

            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm p-3 text-center border-left-danger">
                <h5>VP Pending</h5>
                <h3 id="VPPending" class="text-danger">0</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm p-3 text-center border-left-danger">
                <h5>Director Pending</h5>
                <h3 id="directorPending" class="text-danger">0</h3>
            </div>
        </div>
    </div>



    <!-- APPLY BUTTON -->
    @*  <div class="text-center mt-3 mb-3">
        <a asp-controller="Leave" asp-action="Create"
           class="btn btn-lg text-white shadow"
           style="background: linear-gradient(90deg, #0077c2, #009688); border-radius: 8px;">
            <i class="fa-solid fa-paper-plane me-2"></i> Apply for Leave
        </a>
    </div> 

    <!-- 🔷 STATUS TABS - Modern Pill Design -->
    <div class="d-flex justify-content-end mb-3">
        <div class="pill-tabs" id="statusTabs">
            <button class="pill-btn active" data-status="All">
                <span class="badge-count">@Model.Count()</span>All
            </button>
            <button class="pill-btn" data-status="Pending">
                <span class="badge-count" id="pendingCount">0</span>Pending
            </button>
            <button class="pill-btn" data-status="Approved">
                <span class="badge-count" id="approvedCount">0</span>Approved
            </button>
            <button class="pill-btn" data-status="Rejected">
                <span class="badge-count" id="rejectedCount">0</span>Rejected
            </button>
        </div>
    </div>

    <!-- 🔍 SEARCH -->
    <div class="d-flex justify-content-end mb-2">
        <input type="text" id="tableSearch"
               class="form-control w-25"
               placeholder="Search employee / type / status..." />
    </div>

    <!-- TABLE -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Employee Name</th>
                    <th>Category</th>
                    <th>Leave Type</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Total Days</th>
                    <th>Status</th>
                </tr>
            </thead>

            <tbody id="tableBody">
                @foreach (var item in Model)
                {
                    var empCode = item.Employee?.EmployeeCode ?? "-";
                    var empName = item.Employee?.Name ?? "-";
                    <tr>
                        <td>@($"{empCode} - {empName}")</td>
                        <td>@item.Category</td>
                        <td>@item.LeaveType</td>
                        <td>@item.StartDate.ToString("dd-MM-yyyy")</td>
                        <td>@(item.EndDate?.ToString("dd-MM-yyyy") ?? "N/A")</td>
                        <td>@item.TotalDays</td>
                        <td>@item.OverallStatus</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <span id="pageInfo" class="text-muted"></span>
        <nav>
            <ul class="pagination mb-0" id="pagination"></ul>
        </nav>
    </div>

    <!-- 🔷 LEAVE GRAPH -->
    <div class="card shadow-sm mb-4 mt-3">
        <div class="card-body align-items-center">
            <h5 class="card-title mb-3 ">Leaves per Month (Current Year)</h5>
            <canvas id="leaveMonthlyChart" height="60"></canvas>
        </div>
    </div>
</div>

<style>
    /* Pill Tabs Styling */
    .pill-tabs {
        display: flex;
        gap: 8px;
        background: white;
        padding: 6px;
        border-radius: 50px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .pill-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 20px;
        border: none;
        background: transparent;
        color: #666;
        font-weight: 500;
        border-radius: 50px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

        .pill-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .pill-btn.active {
            background: #0077c2;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 119, 194, 0.2);
        }

            .pill-btn.active:hover {
                background: #0066a8;
            }

    .badge-count {
        background: rgba(255,255,255,0.2);
        color: inherit;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .pill-btn.active .badge-count {
        background: rgba(255,255,255,0.3);
    }

    .pill-btn:not(.active) .badge-count {
        background: #e0e0e0;
        color: #666;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ✅ LEAVE GRAPH SCRIPT -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('/Leave/GetMonthlyLeaveSummaryAll')
                .then(r => r.json())
                .then(data => {
                    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun",
                                        "Jul","Aug","Sep","Oct","Nov","Dec"];
                    const labels = data.map(d => monthNames[d.month - 1]);
                    const values = data.map(d => d.count);

                    new Chart(document.getElementById('leaveMonthlyChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total Leaves',
                                data: values,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                });
        });
    </script>

    <!-- 🔢 SEARCH + PAGINATION + TABS -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rowsPerPage = 10;
            const tableBody = document.getElementById("tableBody");
            const searchBox = document.getElementById("tableSearch");
            const pagination = document.getElementById("pagination");
            const pageInfo = document.getElementById("pageInfo");
            const tabs = document.querySelectorAll("#statusTabs .pill-btn");

            const allRows = Array.from(tableBody.querySelectorAll("tr"));
            let filteredRows = [...allRows];
            let currentPage = 1;
            let activeStatus = "All";

            // Function to update badge counts
            function updateBadgeCounts() {
                const pendingCount = allRows.filter(row =>
                    row.children[6]?.innerText.trim() === "Pending").length;
                const approvedCount = allRows.filter(row =>
                    row.children[6]?.innerText.trim() === "Approved").length;
                const rejectedCount = allRows.filter(row =>
                    row.children[6]?.innerText.trim() === "Rejected").length;

                document.getElementById('pendingCount').textContent = pendingCount;
                document.getElementById('approvedCount').textContent = approvedCount;
                document.getElementById('rejectedCount').textContent = rejectedCount;
            }

            function applyFilters() {
                const q = searchBox.value.toLowerCase().trim();

                filteredRows = allRows.filter(row => {
                    const textMatch = row.innerText.toLowerCase().includes(q);
                    const statusCell = row.children[6]?.innerText.trim(); // Status column
                    const statusMatch = activeStatus === "All" || statusCell === activeStatus;

                    return textMatch && statusMatch;
                });

                currentPage = 1;
                paginate();
            }

            function paginate() {
                const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;

                allRows.forEach(r => r.style.display = "none");

                filteredRows.forEach((r, i) => {
                    if (i >= (currentPage - 1) * rowsPerPage &&
                        i < currentPage * rowsPerPage) {
                        r.style.display = "";
                    }
                });

                pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
                renderPagination(totalPages);
            }

            function renderPagination(totalPages) {
                pagination.innerHTML = "";

                const prev = `<li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                    <a class="page-link">&lsaquo;</a></li>`;
                pagination.insertAdjacentHTML("beforeend", prev);

                for (let i = 1; i <= totalPages; i++) {
                    pagination.insertAdjacentHTML("beforeend",
                        `<li class="page-item ${i === currentPage ? "active" : ""}">
                            <a class="page-link">${i}</a></li>`);
                }

                const next = `<li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
                    <a class="page-link">&rsaquo;</a></li>`;
                pagination.insertAdjacentHTML("beforeend", next);

                [...pagination.children].forEach((li, i) => {
                    li.onclick = () => {
                        if (i === 0 && currentPage > 1) currentPage--;
                        else if (i === pagination.children.length - 1 && currentPage < totalPages) currentPage++;
                        else if (i > 0 && i < pagination.children.length - 1) currentPage = i;
                        paginate();
                    };
                });
            }

            // 🔍 Search
            searchBox.addEventListener("keyup", applyFilters);

            // 🗂 Tabs
            tabs.forEach(tab => {
                tab.addEventListener("click", function () {
                    tabs.forEach(t => t.classList.remove("active"));
                    this.classList.add("active");
                    activeStatus = this.dataset.status;
                    applyFilters();
                });
            });

            // Update badge counts initially
            updateBadgeCounts();
            applyFilters();
        });
    </script>

    <!-- 🔄 PENDING COUNTS -->
    <script>
        function loadPendingCounts() {
            fetch('/Leave/GetPendingCountsall')
                .then(res => res.json())
                .then(data => {
                    managerPending.textContent = data.managerPending;
                    hrPending.textContent = data.hrPending;
                    directorPending.textContent = data.directorPending;
                });
        }
        loadPendingCounts();
    </script>
}
 *@