

@model IEnumerable<HRMS.Models.Leave>
@{
    ViewData["Title"] = "Leave Approvals";
    Layout = "~/Views/Shared/_HRLayout.cshtml";
}

@{
    var userRole = ViewBag.UserRole as string;
}
<h3>Leave Approval</h3>
<hr />

<div id="approval-table-container">

<div class="row mt-4">
   
    @if (userRole == "Manager")
    {
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h6>Pending Approvals</h6>
                <h3 class="text-primary">@ViewBag.ManagerPending</h3>
            </div>
        </div>
    }

    @if (userRole == "HR")
    {
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h6>HR Pending</h6>
                <h3 class="text-warning">@ViewBag.HrPending</h3>
            </div>
        </div>
    }

    @if (userRole == "VP")
    {
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h6>VP Pending</h6>
                <h3 class="text-info">@ViewBag.VpPending</h3>
            </div>
        </div>
    }

    @if (userRole == "Director")
    {
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h6>Director Pending</h6>
                <h3 class="text-danger">@ViewBag.DirectorPending</h3>
            </div>
        </div>
    }

</div>
    <div class="d-flex justify-content-end mb-2">
        <input type="text"
               id="tableSearch"
               class="form-control w-25"
               placeholder="Search employee / reason..." />
    </div>
<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>Employee</th>
            <th>Category</th>
                <th>Leave Type</th>
            <th>Start</th>
            <th>End</th>
            <th>Days</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Remark</th>
            <th>Actions</th>
        </tr>
    </thead>

        <tbody id="tableBody">
        @foreach (var l in Model)
        {
                var empCode = l.Employee?.EmployeeCode ?? "-";
                var empName = l.Employee?.Name ?? "-";
            <tr>
                    <td>@($"{empCode} - {empName}")</td>
                <td>@l.Category</td>
                    <td>@l.LeaveType </td>
                    <td>@(l.StartDate.ToString("dd-MM-yyyy") ?? "N/A")</td>
                    <td>@(l.EndDate?.ToString("dd-MM-yyyy") ?? "N/A")</td>
                <td>@l.TotalDays</td>
                <td>@l.Reason</td>
                    <td>
                        @{
                            var empRole = l.Employee?.Role ?? "Employee";
                        }

                        @if (empRole == "Employee")
                        {
                            <div>
                                HR: @(l.HrStatus ?? "Pending") <br />
                                GM: @(l.ManagerStatus ?? "Pending") <br />
                                VP: @(l.VpStatus ?? "Pending")
                            </div>
                        }
                        else if (empRole == "HR")
                        {
                            <div>
                                GM: @(l.ManagerStatus ?? "Pending") <br />
                                VP: @(l.VpStatus ?? "Pending") <br />
                                Dir: @(l.DirectorStatus ?? "Pending")
                            </div>
                        }
                        else if (empRole == "GM")
                        {
                            <div>
                                
                                VP: @(l.VpStatus ?? "Pending") <br />
                                Dir: @(l.DirectorStatus ?? "Pending")
                            </div>
                        }
                        else if (empRole == "VP")
                        {
                              <div>
                                Dir: @(l.DirectorStatus ?? "Pending")
                                </div> 
                        }
                        else
                        {
                            <!-- Default fallback: show all -->
                            <div>
                                HR: @(l.HrStatus ?? "Pending") <br />
                                GM: @(l.ManagerStatus ?? "Pending") <br />
                                VP: @(l.VpStatus ?? "Pending") <br />
                                Dir: @(l.DirectorStatus ?? "Pending")
                            </div>
                        }
                    </td>


                <td>
                    <input class="form-control" id="remark-@l.Id" />
                </td>

                <td>
                    <a href="/Leave/@ViewBag.ApproveAction?id=@l.Id&approve=true&remark="
                       class="btn btn-success btn-sm">Approve</a>

                    <a href="/Leave/@ViewBag.ApproveAction?id=@l.Id&approve=false&remark="
                       class="btn btn-danger btn-sm">Reject</a>
                </td>
            </tr>
        }
    </tbody>
</table>
    <!-- PAGINATION -->
    
</div>  
<div class="d-flex justify-content-between align-items-center mt-3">
    <span id="pageInfo" class="text-muted"></span>
    <nav>
        <ul class="pagination mb-0" id="pagination"></ul>
    </nav>
</div>
<script >
        document.getElementById("sidebarToggle").addEventListener("click", function () {
        const sidebar = document.getElementById("sidebar-wrapper");

        if (window.innerWidth <= 768) {
            sidebar.classList.toggle("open");
        } else {
            sidebar.classList.toggle("collapsed");
        }
    });


      

</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        const rowsPerPage = 10;
        const tableBody = document.getElementById("tableBody");
        const searchInput = document.getElementById("tableSearch");
        const pagination = document.getElementById("pagination");
        const pageInfo = document.getElementById("pageInfo");

        if (!tableBody) return;

        const allRows = Array.from(tableBody.querySelectorAll("tr"));
        let filteredRows = [...allRows];
        let currentPage = 1;

        function filterRows() {
            const query = searchInput.value.toLowerCase().trim();

            // 🔄 AUTO REFRESH when search box is blank
            if (query === "") {
                filteredRows = [...allRows];
            } else {
                filteredRows = allRows.filter(row =>
                    row.innerText.toLowerCase().includes(query)
                );
            }

            currentPage = 1;
            paginate();
        }

        function paginate() {
            const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;

            allRows.forEach(row => row.style.display = "none");

            filteredRows.forEach((row, index) => {
                if (
                    index >= (currentPage - 1) * rowsPerPage &&
                    index < currentPage * rowsPerPage
                ) {
                    row.style.display = "";
                }
            });

            pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            pagination.innerHTML = "";

            // ◀ PREVIOUS
            const prev = document.createElement("li");
            prev.className = "page-item " + (currentPage === 1 ? "disabled" : "");
            prev.innerHTML = `<a class="page-link">&lsaquo;</a>`;
            prev.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    paginate();
                }
            };
            pagination.appendChild(prev);

            // PAGE NUMBERS
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement("li");
                li.className = "page-item " + (i === currentPage ? "active" : "");
                li.innerHTML = `<a class="page-link">${i}</a>`;
                li.onclick = () => {
                    currentPage = i;
                    paginate();
                };
                pagination.appendChild(li);
            }

            // ▶ NEXT
            const next = document.createElement("li");
            next.className = "page-item " + (currentPage === totalPages ? "disabled" : "");
            next.innerHTML = `<a class="page-link">&rsaquo;</a>`;
            next.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    paginate();
                }
            };
            pagination.appendChild(next);
        }

        // 🔍 LIVE SEARCH
        searchInput.addEventListener("keyup", filterRows);

        // INITIAL LOAD
        paginate();
    });
</script>



