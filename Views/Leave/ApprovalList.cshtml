@model IEnumerable<HRMS.Models.Leave>

@{
    ViewData["Title"] = "Leave Approvals";
    Layout = "~/Views/Shared/_EmployeeLayout.cshtml";
}

<h3>Leave Approval</h3>
<hr />

<div id="approval-table-container">
    @await Html.PartialAsync("_ApprovalTablePartial", Model)
</div>

@* @model IEnumerable<Leave>

@{
    var role = ViewData["ApproverRole"] as string ?? "Manager";
    var approveAction = ViewData["ApproveAction"] as string ?? "ManagerApprove";
    ViewData["Title"] = $"{role} – Leave Approval";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>@role Leave Approval</h3>
    </div>

    <!-- 🔷 Filter Bar -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <input type="hidden" id="approverRole" value="@role" />

            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">From Date</label>
                    <input type="date" id="filterFrom" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date</label>
                    <input type="date" id="filterTo" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Employee</label>
                     <input type="text" id="filterEmployee" class="form-control" placeholder="Employee name" />

                </div>
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select id="filterCategory" class="form-control">
                        <option value="">All</option>
                        <option value="FullDay">Full Day</option>
                        <option value="MultiDay">More Than 1 Day</option>
                        <option value="HalfDay">Half Day</option>
                        <option value="EarlyGoing">Early Going</option>
                        <option value="LateComing">Late Coming</option>
                    </select>
                </div>
            </div>

            <div class="row g-2 align-items-end mt-2">
                <div class="col-md-3">
                    <label class="form-label">Overall Status</label>
                    <select id="filterStatus" class="form-control">
                        <option value="All">All</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <button id="btnApplyFilters" class="btn btn-primary w-100 mt-4">
                        Apply Filters
                    </button>
                </div>
                <div class="col-md-3">
                    <button id="btnResetFilters" class="btn btn-outline-secondary w-100 mt-4">
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 🔷 Approval Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-striped table-bordered align-middle">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Category</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Total Days</th>
                        <th>Reason</th>
                        <th>Status (M / HR / Dir)</th>
                        <th style="width:220px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="approvalTableBody">
                    @* Initial load using server model (will be overwritten by AJAX after)
                    @await Html.PartialAsync("_ApprovalTablePartial", Model)
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        



        document.addEventListener("DOMContentLoaded", function () {

            const roleInput = document.getElementById("approverRole");
            const bodyEl = document.getElementById("approvalTableBody");

            function buildQuery() {
                const role = roleInput.value;
                const from = document.getElementById("filterFrom").value;
                const to = document.getElementById("filterTo").value;
                const employee = document.getElementById("filterEmployee").value;
                const category = document.getElementById("filterCategory").value;
                const status = document.getElementById("filterStatus").value;

                const params = new URLSearchParams();
                params.append("role", role);
                if (from) params.append("from", from);
                if (to) params.append("to", to);
                if (employee) params.append("employee", employee);
                if (category) params.append("category", category);
                if (status && status !== "All") params.append("status", status);

                return params.toString();
            }

            async function loadApprovals() {
                const query = buildQuery();
                const url = "/Leave/GetApprovalTableAjax?" + query;

                const response = await fetch(url, { method: "GET" });
                const html = await response.text();
                bodyEl.innerHTML = html;
            }

            document.getElementById("btnApplyFilters").addEventListener("click", function () {
                loadApprovals();
            });

            document.getElementById("btnResetFilters").addEventListener("click", function () {
                document.getElementById("filterFrom").value = "";
                document.getElementById("filterTo").value = "";
                document.getElementById("filterEmployee").value = "";
                document.getElementById("filterCategory").value = "";
                document.getElementById("filterStatus").value = "All";
                loadApprovals();
            });

            // Auto-load on page load
            loadApprovals();
        });
    </script>
}
 *@