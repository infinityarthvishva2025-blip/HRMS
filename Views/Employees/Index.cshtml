@model List<HRMS.Models.Employee>
@using HRMS.Helpers

@{
    ViewData["Title"] = "Employees";
    Layout = "~/Views/Shared/_HrLayout.cshtml";
}

<style>
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .pagination-right {
        justify-content: flex-end !important;
    }

        .pagination-right .page-item.active .page-link {
            background-color: white;
            border-color: #0d6efd;
        }

        .pagination-right .page-link {
            color: #0d6efd;
        }

    #pagination {
        position: relative;
        padding-top: 10px;
    }

    @@media (max-width: 768px) {

        .btn-group-mobile {
            width: 100%;
            margin-top: 10px;
        }

            .btn-group-mobile .btn {
                width: 48%;
                margin-bottom: 8px;
            }

        h2 {
            font-size: 20px !important;
        }

        .search-filter-container {
            flex-direction: column !important;
        }

        .search-col,
        .filter-col {
            width: 100% !important;
            margin-bottom: 10px;
        }

        .pagination-right {
            justify-content: center !important;
        }
    }

    @@media (max-width: 480px) {

        .btn-group-mobile .btn {
            width: 100%;
        }

        .page-link {
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
        }
    }
</style>


<div class="container py-4">
  
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="fw-bold text-primary mb-2">
            <i class="fa-solid fa-users me-2"></i> Employee Directory
        </h2>
    </div>


    <!-- Search + Status Filter -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">

            <div class="row g-3 align-items-center search-filter-container">

                <!-- Search -->
                <div class="col-md-3 col-lg-4 search-col">
                    <input type="text" id="employeeSearch" class="form-control"
                           placeholder="Search by name, code, email..." />
                </div>

                <!-- Status Dropdown -->
                <div class="col-md-3 col-lg-3 filter-col">
                    <select id="statusFilter" class="form-select"
                            onchange="filterStatus()">

                        <option value="All">All Employees</option>
                        <option value="Active">Active Employees</option>
                        <option value="Inactive">Inactive Employees</option>
                    </select>
                </div>

                <div class="col-md-5 btn-group-mobile">
                    <a class="btn btn-success me-1" asp-action="Create">
                        <i class="fa-solid fa-user-plus me-1"></i> Add New Employee
                    </a>

                    <a class="btn btn-info text-white" asp-action="ExportExcel">
                        <i class="fa-solid fa-file-excel me-1"></i> Export to Excel
                    </a>
                </div>

            </div>

        </div>
    </div>


    <!-- EMPLOYEE TABLE -->
    <div class="card shadow-sm border-0">

        <div class="card-body p-0">

            <div class="table-responsive">

                <table id="employeeTable" class="table table-striped table-bordered mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Employee Code</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Position</th>
                            <th class="text-center" style="width:180px;">Actions</th>
                            <th>Status</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var emp in Model)
                        {
                             
        var token = UrlEncryptionHelper.GenerateToken(
        new Dictionary<string, string>
        {
            ["type"] = "EMP",
            ["empId"] = emp.Id.ToString()
        }
        );
    
                            <tr>
                                <td>@emp.EmployeeCode</td>
                                <td>@emp.Name</td>
                                <td>@emp.Email</td>
                                <td>@emp.Department</td>
                                <td>@emp.Position</td>

                                <td class="text-center">
                                    @* <a class="btn btn-sm btn-primary me-1"
                                       asp-action="Details" asp-route-id="@emp.Id">
                                        <i class="fa-solid fa-eye"></i>
                                    </a> *@
                                    <a asp-action="Details"
                                       class="btn btn-sm btn-primary me-1"
                                       asp-controller="Employees"
                                       asp-route-token="@token">
                                        <i class="fa-solid fa-eye"></i>
                                    </a>
                                    <a class="btn btn-sm btn-warning me-1"
                                       asp-action="Edit" asp-route-token="@token">
                                        <i class="fa-solid fa-pen"></i>
                                    </a>

                                    <a class="btn btn-sm btn-danger"
                                       asp-action="Delete" asp-route-id="@emp.Id"
                                       onclick="return confirm('Are you sure?');">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                </td>

                                <td class="text-center">
                                    <span id="status-badge-@emp.Id"
                                          class="badge @(emp.Status == "Active" ? "bg-success" : "bg-danger") px-3 py-2"
                                          style="cursor:pointer;"
                                          onclick="openStatusModal(@emp.Id, '@emp.Status')">
                                        @(emp.Status == "Active" ? "Active" : "Inactive")
                                    </span>
                                </td>

                            </tr>
                        }
                    </tbody>

                </table>

            </div>

        </div>

        <!-- FIXED NON-MOVING PAGINATION -->
        <div class="card-footer bg-white border-0">
            <div id="pagination" class="d-flex justify-content-end my-3 pe-3 pagination-right"></div>
        </div>

    </div>

</div>



<!-- ================================
    STATUS MODAL
================================ -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Update Employee Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="modalEmpId" />

                <div class="mb-3">
                    <label class="form-label">Select Status</label>
                    <select id="modalStatus" class="form-select" onchange="handleStatusChange()">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>

                <div class="mb-3" id="reasonSection" style="display:none;">
                    <label class="form-label">Reason for Deactivation</label>
                    <select id="modalReason" class="form-select">
                        <option value="">-- Select Reason --</option>
                        <option value="Resigned">Resigned</option>
                        <option value="Fired">Fired</option>
                        <option value="Absconded">Absconded</option>
                        <option value="Contract Ended">Contract Ended</option>
                        <option value="Terminated">Terminated</option>
                        <option value="Retired">Retired</option>
                        <option value="Long Leave">Long Leave</option>
                    </select>
                </div>

            </div>

            <div class="modal-footer d-flex justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStatus()">Save Changes</button>
            </div>

        </div>
    </div>
</div>



@section Scripts {

    <script>

        let currentPage = 1;
        const rowsPerPage = 10;
        let filteredRows = [];


        // PAGE LOAD
        document.addEventListener("DOMContentLoaded", () => {
            applyCombinedFilters();
        });


        // COMBINED FILTERS
        function applyCombinedFilters() {

            const searchTerm = document.getElementById("employeeSearch").value.toLowerCase();
            const selectedStatus = document.getElementById("statusFilter").value;

            const allRows = document.querySelectorAll("#employeeTable tbody tr");

            filteredRows = Array.from(allRows).filter(row => {

                const matchesSearch = row.textContent.toLowerCase().includes(searchTerm);

                const statusBadge = row.querySelector("td:nth-child(7) span");
                const rowStatus = statusBadge ? statusBadge.innerText.trim() : "";

                const matchesStatus =
                    selectedStatus === "All" || selectedStatus === rowStatus;

                return matchesSearch && matchesStatus;
            });

            currentPage = 1;
            paginate();
        }


        // SEARCH EVENT
        document.getElementById("employeeSearch").addEventListener("input", applyCombinedFilters);

        function filterStatus() {
            applyCombinedFilters();
        }


        // PAGINATION
        function paginate() {

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;

            const allRows = document.querySelectorAll("#employeeTable tbody tr");
            allRows.forEach(r => r.style.display = "none");

            for (let i = startIndex; i < endIndex && i < filteredRows.length; i++) {
                filteredRows[i].style.display = "";
            }

            generatePagination();
        }


        function generatePagination() {

            const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
            const paginationDiv = document.getElementById("pagination");

            if (totalPages <= 1) {
                paginationDiv.innerHTML = "";
                return;
            }

            let html = `<nav><ul class="pagination mb-0">`;

            html += `
                <li class="page-item ${currentPage == 1 ? "disabled" : ""}">
                    <button class="page-link" onclick="changePage(${currentPage - 1})">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                </li>
            `;

            for (let i = 1; i <= totalPages; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? "active" : ""}">
                        <button class="page-link" onclick="changePage(${i})">${i}</button>
                    </li>
                `;
            }

            html += `
                <li class="page-item ${currentPage == totalPages ? "disabled" : ""}">
                    <button class="page-link" onclick="changePage(${currentPage + 1})">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </li>
            `;

            html += `</ul></nav>`;

            paginationDiv.innerHTML = html;
        }


        function changePage(page) {
            currentPage = page;
            paginate();
        }


        // STATUS MODAL FUNCTIONS
        function openStatusModal(empId, currentStatus) {

            document.getElementById("modalEmpId").value = empId;
            document.getElementById("modalStatus").value = currentStatus;

            if (currentStatus === "Inactive") {
                document.getElementById("reasonSection").style.display = "block";
            } else {
                document.getElementById("reasonSection").style.display = "none";
                document.getElementById("modalReason").value = "";
            }

            new bootstrap.Modal(document.getElementById("statusModal")).show();
        }


        function saveStatus() {

            let empId = document.getElementById("modalEmpId").value;
            let newStatus = document.getElementById("modalStatus").value;
            let reason = document.getElementById("modalReason").value;

            if (newStatus === "Inactive" && reason === "") {
                alert("Please select a reason.");
                return;
            }

            fetch(`/Employees/UpdateStatus/${empId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    status: newStatus,
                    reason: newStatus === "Active" ? "" : reason
                })
            })
                .then(r => r.json())
                .then(data => {

                    if (!data.success) {
                        alert("Error updating status.");
                        return;
                    }

                    let badge = document.getElementById(`status-badge-${empId}`);
                    badge.innerText = newStatus;
                    badge.className =
                        newStatus === "Active"
                            ? "badge bg-success px-3 py-2"
                            : "badge bg-danger px-3 py-2";

                    applyCombinedFilters();

                    bootstrap.Modal.getInstance(document.getElementById("statusModal")).hide();
                });
        }


        function handleStatusChange() {

            let status = document.getElementById("modalStatus").value;

            if (status === "Inactive") {
                document.getElementById("reasonSection").style.display = "block";
            } else {
                document.getElementById("reasonSection").style.display = "none";
                document.getElementById("modalReason").value = "";
            }
        }

    </script>

}
