@model HRMS.ViewModels.EmployeeEditVm

@{
    ViewData["Title"] = "Edit Employee";
    Layout = "~/Views/Shared/_HrLayout.cshtml";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary">
            <i class="fa-solid fa-user-pen me-2"></i> Edit Employee
        </h3>
        <a asp-controller="Employees" asp-action="Index" class="btn btn-outline-primary">
            <i class="fa-solid fa-list me-1"></i> Back to List
        </a>
    </div>

    <form asp-action="Edit" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.EmployeeCode)

        <div asp-validation-summary="All" class="text-danger mb-3"></div>

        <div class="card shadow-sm border-0 p-4">

            <!-- BASIC DETAILS -->
            <h5 class="fw-bold text-secondary mb-3">Basic Details</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="EmployeeCode" class="form-label">Employee Code</label>
                    <input asp-for="EmployeeCode" class="form-control" readonly />
                </div>

                <div class="col-md-4">
                    <label asp-for="Name" class="form-label">Full Name</label>
                    <input asp-for="Name" class="form-control" required />
                </div>

                <div class="col-md-4">
                    <label asp-for="Email" class="form-label">Email</label>
                    <input asp-for="Email" type="email" class="form-control" required />
                </div>

                <div class="col-md-4">
                    <label asp-for="MobileNumber">Mobile Number</label>
                    <input asp-for="MobileNumber" class="form-control" required />
                </div>

                <div class="col-md-4">
                    <label>Alternate Mobile Number</label>
                    <input asp-for="AlternateMobileNumber" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label>New Password (optional)</label>
                    <div class="input-group">
                        <input asp-for="Password" type="password" id="Password" class="form-control" placeholder="Leave blank to keep existing" />
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('Password', this)">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="col-md-4">
                    <label>Confirm Password (optional)</label>
                    <div class="input-group">
                        <input asp-for="ConfirmPassword" type="password" id="ConfirmPassword" class="form-control" placeholder="Repeat new password" oninput="validatePasswordMatchOptional()" />
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('ConfirmPassword', this)">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                    <span class="text-danger" id="passwordError"></span>
                </div>
            </div>

            <hr />

            <!-- PERSONAL DETAILS -->
            <h5 class="fw-bold text-secondary mb-3">Personal Details</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label asp-for="Gender"></label>
                    <select asp-for="Gender" class="form-select">
                        <option value="">-- Select --</option>
                        <option>Male</option>
                        <option>Female</option>
                        <option>Other</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label>Father Name</label>
                    <input asp-for="FatherName" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label>Mother Name</label>
                    <input asp-for="MotherName" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label asp-for="DOB_Date">Date of Birth</label>
                    <input asp-for="DOB_Date" type="date" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label asp-for="MaritalStatus"></label>
                    <select asp-for="MaritalStatus" class="form-select">
                        <option value="">-- Select --</option>
                        <option>Single</option>
                        <option>Married</option>
                        <option>Divorced</option>
                        <option>Widowed</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label>Profile Photo</label>
                    @if (!string.IsNullOrEmpty(Model.ProfileImagePath))
                    {
                        var url = Url.Content("~/uploads/employees/" + Model.EmployeeCode + "/" + Model.ProfileImagePath);
                        <img src="@url" class="img-thumbnail mb-2" style="max-height:120px;" />
                    }
                    <input type="file" name="ProfilePhoto" class="form-control" accept="image/*" />
                </div>

                <div class="col-md-12">
                    <label asp-for="Address">Current Address</label>
                    <textarea asp-for="Address" id="CurrentAddress" class="form-control" rows="2"></textarea>
                </div>

                <div class="col-md-12 mt-2">
                    <input type="checkbox" id="SameAddressCheckbox" />
                    <label for="SameAddressCheckbox">Permanent address same as current</label>
                </div>

                <div class="col-md-12" id="PermanentAddressSection">
                    <label asp-for="PermanentAddress">Permanent Address</label>
                    <textarea asp-for="PermanentAddress" id="PermanentAddress" class="form-control" rows="2"></textarea>
                </div>
            </div>

            <hr />

            <!-- EXPERIENCE -->
            <h5 class="fw-bold text-secondary mb-3">Experience Details</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Experience Type</label>
                    <select asp-for="ExperienceType" id="ExperienceType" class="form-select">
                        <option value="">-- Select --</option>
                        <option>Fresher</option>
                        <option>Experienced</option>
                    </select>
                </div>

                <div class="col-md-8">
                    <label>Experience Certificates</label>
                    @if (!string.IsNullOrEmpty(Model.ExperienceCertificateFilePath))
                    {
                        var files = Model.ExperienceCertificateFilePath.Split(',', StringSplitOptions.RemoveEmptyEntries);
                        <div class="row g-2">
                            @foreach (var file in files)
                            {
                                var path = Url.Content("~/uploads/employees/" + Model.EmployeeCode + "/" + file);
                                var ext = System.IO.Path.GetExtension(file).ToLower();
                                <div class="col-md-4 text-center">
                                    @if (ext.Contains("jpg") || ext.Contains("png") || ext.Contains("jpeg"))
                                    {
                                        <img src="@path" class="img-fluid img-thumbnail mb-1" style="max-height:120px;" />
                                    }
                                    <a href="@path" target="_blank" class="btn btn-outline-secondary btn-sm w-100 mt-1">View / Download</a>
                                </div>
                            }
                        </div>
                    }
                    <input type="file" name="ExperienceCertificateFiles" class="form-control mt-2" accept=".pdf,image/*" multiple />
                </div>
            </div>

            <hr />

            <!-- HEALTH -->
            <h5 class="fw-bold text-secondary mb-3">Health Information</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Pre-existing Disease</label>
                    <select asp-for="HasDisease" id="HasDisease" class="form-select">
                        <option value="">-- Select --</option>
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label>Disease Name</label>
                    <input asp-for="DiseaseName" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label>Disease Since</label>
                    <input asp-for="DiseaseSince" class="form-control" placeholder="MM/YYYY" />
                </div>
            </div>

            <hr />

            <!-- JOB DETAILS -->
            <h5 class="fw-bold text-secondary mb-3">Job Details</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Department</label>
                    <select asp-for="Department" id="Department" class="form-select">
                        <option value="">-- Select --</option>
                        <option>IT</option>
                        <option>HR</option>
                        <option>Finance</option>
                        <option>Marketing</option>
                        <option>Accounting</option>
                        <option>General Manager</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label>Position</label>
                    <select asp-for="Position" id="Position" class="form-select">
                        <option value="">-- Select Position --</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label>Role</label>
                    <select asp-for="Role" class="form-select">
                        <option value="">-- Select Role --</option>
                        <option>Intern</option>
                        <option>Employee</option>
                        <option>Manager</option>
                        <option>Vice President</option>
                        <option>Director</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label>Salary</label>
                    <input asp-for="Salary" type="number" class="form-control" />
                </div>
            </div>

            <hr />

            <!-- ID PROOFS -->
            <h5 class="fw-bold text-secondary mb-3">ID Proofs</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Aadhaar Number</label>
                    <input asp-for="AadhaarNumber" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label>Aadhaar Card</label>
                    @if (!string.IsNullOrEmpty(Model.AadhaarFilePath))
                    {
                        var url = Url.Content("~/uploads/employees/" + Model.EmployeeCode + "/" + Model.AadhaarFilePath);
                        <img src="@url" class="img-thumbnail mb-2" style="max-height:120px;" />
                    }
                    <input type="file" name="AadhaarFile" class="form-control" accept=".pdf,image/*" />
                </div>

                <div class="col-md-4">
                    <label>PAN Number</label>
                    <input asp-for="PanNumber" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label>PAN Card</label>
                    @if (!string.IsNullOrEmpty(Model.PanFilePath))
                    {
                        var url = Url.Content("~/uploads/employees/" + Model.EmployeeCode + "/" + Model.PanFilePath);
                        <img src="@url" class="img-thumbnail mb-2" style="max-height:120px;" />
                    }
                    <input type="file" name="PanFile" class="form-control" accept=".pdf,image/*" />
                </div>
            </div>

            <hr />

            <!-- BANK DETAILS -->
            <h5 class="fw-bold text-secondary mb-3">Bank Details</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label>Account Holder Name</label>
                    <input asp-for="AccountHolderName" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label>Bank Name</label>
                    <input asp-for="BankName" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label>Account Number</label>
                    <input asp-for="AccountNumber" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label>IFSC</label>
                    <input asp-for="IFSC" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label>Branch</label>
                    <input asp-for="Branch" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label>Passbook File</label>
                    @if (!string.IsNullOrEmpty(Model.PassbookFilePath))
                    {
                        var url = Url.Content("~/uploads/employees/" + Model.EmployeeCode + "/" + Model.PassbookFilePath);
                        <img src="@url" class="img-thumbnail mb-2" style="max-height:120px;" />
                    }
                    <input type="file" name="PassbookFile" class="form-control" accept=".pdf,image/*" />
                </div>
            </div>

            <hr />

            <!-- EMERGENCY CONTACT -->
            <h5 class="fw-bold text-secondary mb-3">Emergency Contact Details</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Name</label>
                    <input asp-for="EmergencyContactName" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label>Relationship</label>
                    <input asp-for="EmergencyContactRelationship" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label>Mobile</label>
                    <input asp-for="EmergencyContactMobile" class="form-control" />
                </div>

                <div class="col-md-12">
                    <label>Address</label>
                    <textarea asp-for="EmergencyContactAddress" class="form-control" rows="2"></textarea>
                </div>
            </div>

            <div class="mt-4 text-end">
                <button type="submit" class="btn btn-success px-5">
                    <i class="fa-solid fa-check me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function togglePassword(fieldId, btn) {
            const input = document.getElementById(fieldId);
            const icon = btn.querySelector("i");
            if (input.type === "password") {
                input.type = "text";
                icon.classList.replace("fa-eye", "fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.replace("fa-eye-slash", "fa-eye");
            }
        }

        function validatePasswordMatchOptional() {
            const pwd = document.getElementById("Password");
            const conf = document.getElementById("ConfirmPassword");
            const err = document.getElementById("passwordError");
            if (pwd.value === "" && conf.value === "") {
                err.textContent = "";
                return;
            }
            err.textContent = (pwd.value !== conf.value) ? "Passwords do not match." : "";
        }

        // Sync address
        const sameAddressCheckbox = document.getElementById("SameAddressCheckbox");
        const currentAddress = document.getElementById("CurrentAddress");
        const permanentAddress = document.getElementById("PermanentAddress");
        const permanentSection = document.getElementById("PermanentAddressSection");

        sameAddressCheckbox.addEventListener("change", () => {
            if (sameAddressCheckbox.checked) {
                permanentAddress.value = currentAddress.value;
                permanentSection.classList.add("d-none");
            } else {
                permanentSection.classList.remove("d-none");
            }
        });

        currentAddress.addEventListener("input", () => {
            if (sameAddressCheckbox.checked) {
                permanentAddress.value = currentAddress.value;
            }
        });

        // Department -> Position loader
        const dept = document.getElementById("Department");
        const pos = document.getElementById("Position");

        dept.addEventListener("change", function () {
            fetch(`/Employees/GetPositions?department=${this.value}`)
                .then(r => r.json())
                .then(list => {
                    pos.innerHTML = '<option value="">-- Select Position --</option>';
                    list.forEach(item => pos.innerHTML += `<option value="${item}">${item}</option>`);
                });
        });
    </script>
}
