@model List<HRMS.Models.ViewModels.PayrollSummaryVm>

@{
    ViewData["Title"] = "Payroll List";
    Layout = "~/Views/Shared/_HrLayout.cshtml";
}

<h2 class="mb-3">Payroll List</h2>

<!-- ACTION BAR -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <button id="exportExcelBtn" class="btn btn-success">
        📥 Export Excel (All Employees)
    </button>

    <select id="pageSize" class="form-select w-auto">
        <option value="5">5 rows</option>
        <option value="10" selected>10 rows</option>
        <option value="20">20 rows</option>
        <option value="50">50 rows</option>
        <option value="100">100 rows</option>
        <option value="500">500 rows</option>
    </select>
</div>

<!-- TABLE -->
<div class="table-responsive">
    <table id="payrollTable" class="table table-bordered table-striped text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>Emp Code</th>
                <th>Name</th>
                <th>Working Days</th>
                <th>Half Days</th>
                <th>Absent Days</th>
                <th>Paid Days</th>
                <th>Basic Salary</th>
                <th>Gross Salary</th>
                <th>Deduction</th>
                <th>Net Salary</th>
                <th>Payslip</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.EmpCode</td>
                    <td class="text-start">@item.EmpName</td>

                    <td>@item.TotalDaysInMonth</td>

                    <!-- HALF DAYS -->
                    <td class="text-warning fw-bold">
                        @item.PresentHalfDays
                    </td>

                    <!-- ABSENT DAYS -->
                    <td class="text-danger fw-bold">
                        @item.AbsentDays
                    </td>

                    <!-- PAID DAYS -->
                    <td class="text-primary fw-bold">
                        @item.PaidDays.ToString("0.0")
                    </td>

                    <td>@item.MonthlySalary.ToString("0.00")</td>
                    <td class="fw-bold">@item.GrossSalary.ToString("0.00")</td>
                    <td class="text-danger">@item.TotalDeductions.ToString("0.00")</td>
                    <td class="fw-bold text-success">@item.NetSalary.ToString("0.00")</td>

                    <td>
                        @* <a asp-action="DownloadSalarySlipByDateRange"
                           asp-controller="Payroll"
                           asp-route-empCode="@item.EmpCode"
                           asp-route-year="@item.Year"
                           asp-route-month="@item.Month"
                           class="btn btn-primary btn-sm"
                           target="_blank">
                            Slip
                        </a> *@
                        <a asp-action="DownloadSalarySlipByDateRange"
                           asp-controller="Payroll"
                           asp-route-empCode="@item.EmpCode"
                           asp-route-fromDate="@item.FromDate.ToString("yyyy-MM-dd")"
                           asp-route-toDate="@item.ToDate.ToString("yyyy-MM-dd")"
                           class="btn btn-primary btn-sm"
                           target="_blank">
                            Slip
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- INFO + PAGINATION -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <div id="recordInfo" class="text-muted"></div>
    <ul id="pagination" class="pagination mb-0"></ul>
</div>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    let currentPage = 1;
    let rowsPerPage = 10;

    const tbody = document.querySelector("#payrollTable tbody");
    const allRows = Array.from(tbody.rows);
    const pagination = document.getElementById("pagination");
    const pageSizeSelect = document.getElementById("pageSize");
    const recordInfo = document.getElementById("recordInfo");

    function renderTable() {
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        allRows.forEach((row, index) => {
            row.style.display =
                index >= start && index < end ? "" : "none";
        });

        recordInfo.innerText =
            `Showing ${start + 1}-${Math.min(end, allRows.length)} of ${allRows.length} records`;
    }

    function setupPagination() {
        pagination.innerHTML = "";
        const pageCount = Math.ceil(allRows.length / rowsPerPage);

        pagination.innerHTML += `
            <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">&lt;</a>
            </li>`;

        for (let i = 1; i <= pageCount; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === currentPage ? "active" : ""}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
        }

        pagination.innerHTML += `
            <li class="page-item ${currentPage === pageCount ? "disabled" : ""}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">&gt;</a>
            </li>`;
    }

    function changePage(page) {
        const pageCount = Math.ceil(allRows.length / rowsPerPage);
        if (page < 1 || page > pageCount) return;
        currentPage = page;
        renderTable();
        setupPagination();
    }

    pageSizeSelect.addEventListener("change", () => {
        rowsPerPage = parseInt(pageSizeSelect.value);
        currentPage = 1;
        renderTable();
        setupPagination();
    });

    renderTable();
    setupPagination();

    document.getElementById("exportExcelBtn").onclick = function () {
        const wb = XLSX.utils.book_new();
        const wsData = [];

        wsData.push([
            "Emp Code","Name","Working Days",
            "Half Days","Absent Days","Paid Days",
            "Basic Salary","Gross Salary","Deduction","Net Salary"
        ]);

        allRows.forEach(r => {
            const c = r.cells;
            wsData.push([
                c[0].innerText, c[1].innerText, c[2].innerText,
                c[3].innerText, c[4].innerText, c[5].innerText,
                c[6].innerText, c[7].innerText, c[8].innerText, c[9].innerText
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Payroll");
        XLSX.writeFile(wb, "Payroll_All_Employees.xlsx");
    };
</script>
